{% extends 'base.html' %}
{% block title %}{{ subject.name }}{% endblock %}

{% block content %}
<h1 class="h2 mb-4">{{ subject.name }}</h1>
<a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm mb-4"><i class="bi bi-arrow-left me-2"></i>Back to Dashboard</a>

{% if upcoming_meeting %}
<div class="alert alert-info d-flex align-items-center shadow-sm">
    <i class="bi bi-camera-video-fill fs-3 me-3"></i>
    <div>
        <strong>Upcoming Class:</strong> {{ upcoming_meeting.topic }} via {{ upcoming_meeting.platform }}
        <br>
        <strong>Time:</strong> {{ upcoming_meeting.meeting_datetime }} 
        <a href="{{ upcoming_meeting.url }}" class="btn btn-primary btn-sm ms-3" target="_blank">Join Meeting</a>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header fw-bold"><i class="bi bi-megaphone-fill me-2"></i>Announcements</div>
            <div class="list-group list-group-flush">
                {% for item in announcements %}
                <div class="list-group-item">
                    <p class="mb-1">{{ item.text }}</p>
                    <small class="text-muted">{{ item.timestamp }}</small>
                </div>
                {% else %}
                <div class="list-group-item">No announcements yet.</div>
                {% endfor %}
            </div>
        </div>
        <div class="card shadow-sm mb-4">
            <div class="card-header fw-bold"><i class="bi bi-folder-fill me-2"></i>Course Materials</div>
            <div class="list-group list-group-flush">
                {% for material in materials %}
                <a href="{{ material.url if material.type == 'link' else url_for('uploaded_file', subject_name=subject.name, filename=material.filename) }}" class="list-group-item list-group-item-action" target="_blank">
                    <i class="bi bi-{{ 'link-45deg' if material.type == 'link' else 'file-earmark-arrow-down' }} me-2"></i>
                    {{ material.filename }}
                </a>
                {% else %}
                <div class="list-group-item">No materials available yet.</div>
                {% endfor %}
            </div>
        </div>
        <div class="card shadow-sm mb-4">
            <div class="card-header fw-bold"><i class="bi bi-robot me-2"></i>AI Helper</div>
            <div class="card-body">
                <p>Have a question about the materials? Ask the AI assistant.</p>
                <textarea id="ai-student-question" class="form-control" rows="3" placeholder="e.g., Can you summarize the main points of 'Introduction.pdf'?"></textarea>
                <button id="ask-ai-btn" class="btn btn-success mt-2">Ask AI</button>
                <div id="ai-answer-box" class="mt-3 p-3 bg-light rounded" style="display:none; white-space: pre-wrap;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card text-center shadow-sm mb-4">
            <div class="card-body d-flex flex-column justify-content-center">
                <i class="bi bi-chat-square-dots-fill fs-1 text-success"></i>
                <h5 class="card-title mt-3">Discussion Forum</h5>
                <p class="card-text">Ask questions and collaborate.</p>
                <a href="{{ url_for('forum', subject_id=subject.id) }}" class="btn btn-success">Go to Forum</a>
            </div>
        </div>

        {% if quiz %}
        <div class="card text-center shadow-sm mb-4">
            <div class="card-body d-flex flex-column justify-content-center">
                <i class="bi bi-patch-question-fill fs-1 text-primary"></i>
                <h5 class="card-title mt-3">Quiz Available</h5>
                <p class="card-text">Test your knowledge.</p>
                <a href="{{ url_for('take_quiz', quiz_id=quiz.id) }}" class="btn btn-primary">Take Quiz</a>
            </div>
        </div>
        {% endif %}
        
        {% if assignment %}
        <div class="card shadow-sm mb-4">
            <div class="card-header fw-bold"><i class="bi bi-file-earmark-text-fill me-2"></i>Assignment: {{ assignment.title }}</div>
            <div class="card-body">
                <p><strong>Instructions:</strong> {{ assignment.instructions }}</p>
                <hr>
                {% if submission %}
                    <div class="alert alert-success">
                        You have submitted this assignment.
                        {% if submission.grade %}<hr><strong>Grade: {{ submission.grade }}</strong><p class="mb-0">Feedback: {{ submission.feedback }}</p>{% endif %}
                    </div>
                    {% if assignment.assignment_type == 'text' and not submission.grade %}
                    <div class="d-grid">
                        <button class="btn btn-info" id="ai-feedback-btn" data-submission-id="{{ submission.id }}"><i class="bi bi-robot me-2"></i>Get AI Feedback</button>
                    </div>
                    <div id="ai-feedback-response" class="mt-3 p-3 bg-light rounded" style="display:none; white-space: pre-wrap;"></div>
                    {% endif %}
                {% else %}
                    <form action="{{ url_for('submit_assignment', assignment_id=assignment.id) }}" method="post" enctype="multipart/form-data">
                        {% if assignment.assignment_type == 'file' %}
                            <div class="input-group">
                                <input type="file" class="form-control" name="submission_file" required>
                                <button class="btn btn-success" type="submit">Submit</button>
                            </div>
                        {% elif assignment.assignment_type == 'text' %}
                            <textarea name="text_content" class="form-control" rows="8" placeholder="Write your response here..." required></textarea>
                            <div class="d-grid mt-2">
                                <button class="btn btn-success" type="submit">Submit</button>
                            </div>
                        {% endif %}
                    </form>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('ai-feedback-btn')?.addEventListener('click', async function() {
    const submissionId = this.dataset.submissionId;
    const answerBox = document.getElementById('ai-feedback-response');
    
    this.textContent = 'ðŸ¤– Thinking...';
    this.disabled = true;
    answerBox.style.display = 'block';
    answerBox.textContent = 'Please wait while the AI generates your feedback...';

    const response = await fetch(`/get_ai_feedback/${submissionId}`);

    if (response.ok) {
        const data = await response.json();
        answerBox.textContent = data.feedback || data.error;
    } else {
        answerBox.textContent = 'An error occurred while contacting the AI helper.';
    }
    this.innerHTML = '<i class="bi bi-robot me-2"></i>Get AI Feedback';
    this.disabled = false;
});
</script>

<script>
document.getElementById('ask-ai-btn')?.addEventListener('click', async function() {
    const question = document.getElementById('ai-student-question').value;
    const answerBox = document.getElementById('ai-answer-box');
    if (!question) { alert('Please enter a question.'); return; }

    this.textContent = 'Thinking...';
    this.disabled = true;
    answerBox.style.display = 'block';
    answerBox.textContent = '...';

    const response = await fetch("{{ url_for('ai_helper') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: question, subject_id: {{ subject.id }} })
    });

    if (response.ok) {
        const data = await response.json();
        answerBox.textContent = data.answer || data.error;
    } else {
        answerBox.textContent = 'An error occurred while contacting the AI helper.';
    }

    this.textContent = 'Ask AI';
    this.disabled = false;
});
</script>
{% endblock %}