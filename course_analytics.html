{% extends 'base.html' %}
{% block title %}Analytics for {{ subject.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 mb-0">Course Analytics: {{ subject.name }}</h1>
    <a href="{{ url_for('manage_subject', subject_name=subject.name) }}" class="btn btn-secondary"><i class="bi bi-arrow-left me-2"></i>Back to Management</a>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card text-center text-white bg-primary mb-3 shadow-sm">
            <div class="card-body">
                <h5 class="card-title display-6">{{ "%.2f"|format(avg_score) }}%</h5>
                <p class="card-text">Average Quiz Score</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card text-center text-white bg-success mb-3 shadow-sm">
            <div class="card-body">
                <h5 class="card-title display-6">{{ "%.2f"|format(submission_rate) }}%</h5>
                <p class="card-text">Assignment Submission Rate</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-7">
        <div class="card shadow-sm">
            <div class="card-header fw-bold">Quiz Score Distribution (%)</div>
            <div class="card-body">
                <canvas id="quizScoresChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="card shadow-sm">
            <div class="card-header fw-bold">Assignment Grade Distribution</div>
            <div class="card-body">
                <canvas id="gradeDistChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script>
    Chart.register(ChartDataLabels);

    // Grade Distribution Chart (Pie)
    const gradeCtx = document.getElementById('gradeDistChart');
    new Chart(gradeCtx, {
        type: 'pie',
        data: {
            labels: {{ grade_labels|safe }},
            datasets: [{
                label: 'Grade Count',
                data: {{ grade_data|safe }},
                backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d', '#007bff'],
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: false },
                datalabels: {
                    formatter: (value, ctx) => {
                        let sum = 0;
                        let dataArr = ctx.chart.data.datasets[0].data;
                        dataArr.map(data => { sum += data; });
                        let percentage = (value*100 / sum).toFixed(2)+"%";
                        return percentage;
                    },
                    color: '#fff',
                }
            }
        },
    });

    // Quiz Score Distribution (Histogram-like Bar Chart)
    const quizScoresCtx = document.getElementById('quizScoresChart');
    const scores = {{ quiz_score_data|safe }};
    const bins = { '0-19': 0, '20-39': 0, '40-59': 0, '60-79': 0, '80-100': 0 };
    scores.forEach(score => {
        if (score <= 19) bins['0-19']++;
        else if (score <= 39) bins['20-39']++;
        else if (score <= 59) bins['40-59']++;
        else if (score <= 79) bins['60-79']++;
        else bins['80-100']++;
    });

    new Chart(quizScoresCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(bins),
            datasets: [{
                label: '# of Students',
                data: Object.values(bins),
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
</script>
{% endblock %}